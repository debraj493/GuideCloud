#!/bin/bash
set -euo pipefail

VM_DIR="$HOME/vms"
mkdir -p "$VM_DIR"

# ১. KVM এনেবেলার এবং ডিপেন্ডেন্সি ফিক্সার
setup_system() {
    echo "Checking KVM Support..."
    # KVM মডিউল লোড করার চেষ্টা
    sudo modprobe kvm-intel || sudo modprobe kvm-amd || true
    
    # পারমিশন ফিক্স করা যাতে ইউজার KVM ব্যবহার করতে পারে
    sudo usermod -aG kvm $USER || true
    sudo chmod 666 /dev/kvm || true
    
    # প্রয়োজনীয় প্যাকেজ চেক
    if ! command -v qemu-system-x86_64 &> /dev/null; then
        echo "Installing QEMU Tools..."
        sudo apt update -qq && sudo apt install -y qemu-kvm cloud-image-utils wget -qq
    fi
}

display_header() {
    clear
    echo "=========================================================="
    echo "    RYZEN 9 UNIVERSAL MANAGER (KVM ENABLED)"
    echo "=========================================================="
}

# (বাকি ফাংশনগুলো যেমন create_new_vm, list_vms আপনার আগের কোড অনুযায়ী কাজ করবে)

start_vm() {
    display_header
    local vms=($(find "$VM_DIR" -name "*.conf" -exec basename {} .conf \; 2>/dev/null))
    if [ ${#vms[@]} -eq 0 ]; then echo "No VMs found!"; return; fi
    
    for i in "${!vms[@]}"; do echo "$((i+1))) ${vms[$i]}"; done
    read -p "Select VM Number: " idx
    source "$VM_DIR/${vms[$((idx-1))]}.conf"

    # হার্ডওয়্যার সাপোর্ট চেক
    local ACCEL="tcg"
    local CPU_TYPE="max"
    
    if [ -e /dev/kvm ] && [ -w /dev/kvm ]; then
        ACCEL="kvm"
        CPU_TYPE="host"
        echo "STATUS: RUNNING WITH KVM ACCELERATION (FAST)"
    else
        echo "STATUS: KVM NOT DETECTED. RUNNING IN TCG MODE (SLOW)"
    fi

    # বুট করার সময় আর আটকে যাবে না
    qemu-system-x86_64 \
        -accel "$ACCEL" \
        -m "$MEMORY" \
        -smp "$CPUS" \
        -cpu "$CPU_TYPE",vendor=AuthenticAMD,model_id="AMD Ryzen 9 5950X 16-Core Processor" \
        -drive "file=$IMG_FILE,format=qcow2,if=virtio" \
        -drive "file=$SEED_FILE,format=raw,if=virtio" \
        -netdev user,id=n1,hostfwd=tcp::$SSH_PORT-:22 \
        -device virtio-net-pci,netdev=n1 \
        -nographic -serial mon:stdio
}

# মেইন রান
setup_system
# (মেনু লজিক চলবে এখানে)

